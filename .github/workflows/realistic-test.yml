# AUTO-GENERATED by scripts/generate-self-test.ts — do not edit manually
# Regenerate: npx tsx scripts/generate-self-test.ts

name: Realistic Test

on:
  workflow_dispatch:

concurrency:
  group: realistic-test
  cancel-in-progress: true

jobs:
  realistic:
    name: Realistic — ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        include:
          - id: realistic-5m
            name: "Realistic mix — 5m steady traffic"
            has_expected: false
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        id: monitor
        uses: hesreallyhim/github-api-usage-monitor@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          diagnostics: true
          artifact_name: github-api-usage-monitor-${{ matrix.id }}

      - name: Run scenario
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SCENARIO_ID: ${{ matrix.id }}
        run: node scripts/run-scenario.mjs

  realistic-diag:
    name: Diagnostics — ${{ matrix.name }}
    runs-on: ubuntu-latest
    needs: [realistic]
    if: ${{ needs.realistic.result != 'skipped' }}
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        include:
          - id: realistic-5m
            name: "Realistic mix — 5m steady traffic"
            has_expected: false
    steps:
      - uses: actions/checkout@v4

      - name: Download diagnostics artifacts
        uses: actions/download-artifact@v6
        with:
          name: github-api-usage-monitor-${{ matrix.id }}
          path: ${{ runner.temp }}/github-api-usage-monitor-artifacts/${{ matrix.id }}

      - name: Render diagnostics
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor-artifacts/${{ matrix.id }}
          SCENARIO_NAME: ${{ matrix.name }}
        run: node scripts/render-diagnostics.mjs >> "$GITHUB_STEP_SUMMARY"
