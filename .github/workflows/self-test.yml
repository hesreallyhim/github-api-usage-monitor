# AUTO-GENERATED by scripts/generate-self-test.ts — do not edit manually
# Regenerate: npx tsx scripts/generate-self-test.ts

name: Self-Test

on:
  workflow_dispatch:
    inputs:
      strict_validation:
        description: "Fail jobs on assertion mismatch"
        type: boolean
        default: false

concurrency:
  group: self-test
  cancel-in-progress: true

jobs:
  baseline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Wait for polls (90s total)"
        run: sleep 90

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== baseline: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

  core-5:
    runs-on: ubuntu-latest
    needs: [baseline]
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Scenario: 5 core GET calls"
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 5x core
          for i in $(seq 1 5); do
            echo "--- core call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                "https://api.github.com/repos/${REPO}" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 2
          done

      - name: "Wait for polls (90s total)"
        run: sleep 70

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== core-5: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

      - name: Validate expectations
        if: inputs.strict_validation == 'true'
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor
        run: |
          python3 << 'PYEOF'
          import json, sys, os
          state_path = os.path.join(os.environ['STATE_DIR'], 'state.json')
          with open(state_path) as f:
              state = json.load(f)
          buckets = state.get('buckets', {})
          expectations = {
              'core': {'delta': 5, 'max_windows': 0}
          }
          errors = []
          for bucket_name, expect in expectations.items():
              b = buckets.get(bucket_name)
              if not b:
                  errors.append(bucket_name + ': not found in state')
                  continue
              if b['total_used'] < expect['delta']:
                  errors.append(bucket_name + ': total_used=' + str(b['total_used']) + ' < expected ' + str(expect['delta']))
              if b['windows_crossed'] > expect['max_windows']:
                  errors.append(bucket_name + ': windows_crossed=' + str(b['windows_crossed']) + ' > max ' + str(expect['max_windows']))
          if errors:
              print('VALIDATION FAILED:')
              for e in errors: print('  - ' + e)
              sys.exit(1)
          print('All assertions passed')
          PYEOF

  core-10:
    runs-on: ubuntu-latest
    needs: [core-5]
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Scenario: 10 core GET calls"
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 10x core
          for i in $(seq 1 10); do
            echo "--- core call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                "https://api.github.com/repos/${REPO}" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 1
          done

      - name: "Wait for polls (90s total)"
        run: sleep 60

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== core-10: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

      - name: Validate expectations
        if: inputs.strict_validation == 'true'
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor
        run: |
          python3 << 'PYEOF'
          import json, sys, os
          state_path = os.path.join(os.environ['STATE_DIR'], 'state.json')
          with open(state_path) as f:
              state = json.load(f)
          buckets = state.get('buckets', {})
          expectations = {
              'core': {'delta': 10, 'max_windows': 0}
          }
          errors = []
          for bucket_name, expect in expectations.items():
              b = buckets.get(bucket_name)
              if not b:
                  errors.append(bucket_name + ': not found in state')
                  continue
              if b['total_used'] < expect['delta']:
                  errors.append(bucket_name + ': total_used=' + str(b['total_used']) + ' < expected ' + str(expect['delta']))
              if b['windows_crossed'] > expect['max_windows']:
                  errors.append(bucket_name + ': windows_crossed=' + str(b['windows_crossed']) + ' > max ' + str(expect['max_windows']))
          if errors:
              print('VALIDATION FAILED:')
              for e in errors: print('  - ' + e)
              sys.exit(1)
          print('All assertions passed')
          PYEOF

  search-2:
    runs-on: ubuntu-latest
    needs: [core-10]
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Scenario: 2 search calls"
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 2x search
          for i in $(seq 1 2); do
            echo "--- search call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                "https://api.github.com/search/repositories?q=test" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 3
          done

      - name: "Wait for polls (90s total)"
        run: sleep 80

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== search-2: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

      - name: Validate expectations
        if: inputs.strict_validation == 'true'
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor
        run: |
          python3 << 'PYEOF'
          import json, sys, os
          state_path = os.path.join(os.environ['STATE_DIR'], 'state.json')
          with open(state_path) as f:
              state = json.load(f)
          buckets = state.get('buckets', {})
          expectations = {
              'search': {'delta': 2, 'max_windows': 0}
          }
          errors = []
          for bucket_name, expect in expectations.items():
              b = buckets.get(bucket_name)
              if not b:
                  errors.append(bucket_name + ': not found in state')
                  continue
              if b['total_used'] < expect['delta']:
                  errors.append(bucket_name + ': total_used=' + str(b['total_used']) + ' < expected ' + str(expect['delta']))
              if b['windows_crossed'] > expect['max_windows']:
                  errors.append(bucket_name + ': windows_crossed=' + str(b['windows_crossed']) + ' > max ' + str(expect['max_windows']))
          if errors:
              print('VALIDATION FAILED:')
              for e in errors: print('  - ' + e)
              sys.exit(1)
          print('All assertions passed')
          PYEOF

  code-search-2:
    runs-on: ubuntu-latest
    needs: [search-2]
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Scenario: 2 code_search calls"
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 2x code_search
          for i in $(seq 1 2); do
            echo "--- code_search call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                "https://api.github.com/search/code?q=test+repo:${REPO}" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 3
          done

      - name: "Wait for polls (90s total)"
        run: sleep 80

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== code-search-2: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

      - name: Validate expectations
        if: inputs.strict_validation == 'true'
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor
        run: |
          python3 << 'PYEOF'
          import json, sys, os
          state_path = os.path.join(os.environ['STATE_DIR'], 'state.json')
          with open(state_path) as f:
              state = json.load(f)
          buckets = state.get('buckets', {})
          expectations = {
              'code_search': {'delta': 2, 'max_windows': 0}
          }
          errors = []
          for bucket_name, expect in expectations.items():
              b = buckets.get(bucket_name)
              if not b:
                  errors.append(bucket_name + ': not found in state')
                  continue
              if b['total_used'] < expect['delta']:
                  errors.append(bucket_name + ': total_used=' + str(b['total_used']) + ' < expected ' + str(expect['delta']))
              if b['windows_crossed'] > expect['max_windows']:
                  errors.append(bucket_name + ': windows_crossed=' + str(b['windows_crossed']) + ' > max ' + str(expect['max_windows']))
          if errors:
              print('VALIDATION FAILED:')
              for e in errors: print('  - ' + e)
              sys.exit(1)
          print('All assertions passed')
          PYEOF

  graphql-2:
    runs-on: ubuntu-latest
    needs: [code-search-2]
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Scenario: 2 GraphQL calls"
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 2x graphql
          for i in $(seq 1 2); do
            echo "--- graphql call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                -H "Content-Type: application/json" \
                -d '{"query":"{ viewer { login } }"}' \
                "https://api.github.com/graphql" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 3
          done

      - name: "Wait for polls (90s total)"
        run: sleep 80

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== graphql-2: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

      - name: Validate expectations
        if: inputs.strict_validation == 'true'
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor
        run: |
          python3 << 'PYEOF'
          import json, sys, os
          state_path = os.path.join(os.environ['STATE_DIR'], 'state.json')
          with open(state_path) as f:
              state = json.load(f)
          buckets = state.get('buckets', {})
          expectations = {
              'graphql': {'delta': 2, 'max_windows': 0}
          }
          errors = []
          for bucket_name, expect in expectations.items():
              b = buckets.get(bucket_name)
              if not b:
                  errors.append(bucket_name + ': not found in state')
                  continue
              if b['total_used'] < expect['delta']:
                  errors.append(bucket_name + ': total_used=' + str(b['total_used']) + ' < expected ' + str(expect['delta']))
              if b['windows_crossed'] > expect['max_windows']:
                  errors.append(bucket_name + ': windows_crossed=' + str(b['windows_crossed']) + ' > max ' + str(expect['max_windows']))
          if errors:
              print('VALIDATION FAILED:')
              for e in errors: print('  - ' + e)
              sys.exit(1)
          print('All assertions passed')
          PYEOF

  mixed-small:
    runs-on: ubuntu-latest
    needs: [graphql-2]
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Scenario: Mixed — 2 core + 2 search + 2 graphql"
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 2x core
          for i in $(seq 1 2); do
            echo "--- core call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                "https://api.github.com/repos/${REPO}" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 2
          done

          # 2x search
          for i in $(seq 1 2); do
            echo "--- search call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                "https://api.github.com/search/repositories?q=test" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 2
          done

          # 2x graphql
          for i in $(seq 1 2); do
            echo "--- graphql call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                -H "Content-Type: application/json" \
                -d '{"query":"{ viewer { login } }"}' \
                "https://api.github.com/graphql" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 2
          done

      - name: "Wait for polls (120s total)"
        run: sleep 96

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== mixed-small: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

      - name: Validate expectations
        if: inputs.strict_validation == 'true'
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor
        run: |
          python3 << 'PYEOF'
          import json, sys, os
          state_path = os.path.join(os.environ['STATE_DIR'], 'state.json')
          with open(state_path) as f:
              state = json.load(f)
          buckets = state.get('buckets', {})
          expectations = {
              'core': {'delta': 2, 'max_windows': 0},
              'search': {'delta': 2, 'max_windows': 0},
              'graphql': {'delta': 2, 'max_windows': 0}
          }
          errors = []
          for bucket_name, expect in expectations.items():
              b = buckets.get(bucket_name)
              if not b:
                  errors.append(bucket_name + ': not found in state')
                  continue
              if b['total_used'] < expect['delta']:
                  errors.append(bucket_name + ': total_used=' + str(b['total_used']) + ' < expected ' + str(expect['delta']))
              if b['windows_crossed'] > expect['max_windows']:
                  errors.append(bucket_name + ': windows_crossed=' + str(b['windows_crossed']) + ' > max ' + str(expect['max_windows']))
          if errors:
              print('VALIDATION FAILED:')
              for e in errors: print('  - ' + e)
              sys.exit(1)
          print('All assertions passed')
          PYEOF

  core-burst:
    runs-on: ubuntu-latest
    needs: [mixed-small]
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Scenario: 5 core GET calls — burst (no sleep)"
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 5x core
          for i in $(seq 1 5); do
            echo "--- core call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                "https://api.github.com/repos/${REPO}" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
          done

      - name: "Wait for polls (90s total)"
        run: sleep 80

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== core-burst: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

      - name: Validate expectations
        if: inputs.strict_validation == 'true'
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor
        run: |
          python3 << 'PYEOF'
          import json, sys, os
          state_path = os.path.join(os.environ['STATE_DIR'], 'state.json')
          with open(state_path) as f:
              state = json.load(f)
          buckets = state.get('buckets', {})
          expectations = {
              'core': {'delta': 5, 'max_windows': 0}
          }
          errors = []
          for bucket_name, expect in expectations.items():
              b = buckets.get(bucket_name)
              if not b:
                  errors.append(bucket_name + ': not found in state')
                  continue
              if b['total_used'] < expect['delta']:
                  errors.append(bucket_name + ': total_used=' + str(b['total_used']) + ' < expected ' + str(expect['delta']))
              if b['windows_crossed'] > expect['max_windows']:
                  errors.append(bucket_name + ': windows_crossed=' + str(b['windows_crossed']) + ' > max ' + str(expect['max_windows']))
          if errors:
              print('VALIDATION FAILED:')
              for e in errors: print('  - ' + e)
              sys.exit(1)
          print('All assertions passed')
          PYEOF

  search-window-cross:
    runs-on: ubuntu-latest
    needs: [core-burst]
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Scenario: 2 search calls — 65s apart (window crossing)"
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 2x search
          for i in $(seq 1 2); do
            echo "--- search call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                "https://api.github.com/search/repositories?q=test" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 65
          done

      - name: "Wait for polls (150s total)"
        run: sleep 16

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== search-window-cross: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

      - name: Validate expectations
        if: inputs.strict_validation == 'true'
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor
        run: |
          python3 << 'PYEOF'
          import json, sys, os
          state_path = os.path.join(os.environ['STATE_DIR'], 'state.json')
          with open(state_path) as f:
              state = json.load(f)
          buckets = state.get('buckets', {})
          expectations = {
              'search': {'delta': 2, 'max_windows': 1}
          }
          errors = []
          for bucket_name, expect in expectations.items():
              b = buckets.get(bucket_name)
              if not b:
                  errors.append(bucket_name + ': not found in state')
                  continue
              if b['total_used'] < expect['delta']:
                  errors.append(bucket_name + ': total_used=' + str(b['total_used']) + ' < expected ' + str(expect['delta']))
              if b['windows_crossed'] > expect['max_windows']:
                  errors.append(bucket_name + ': windows_crossed=' + str(b['windows_crossed']) + ' > max ' + str(expect['max_windows']))
          if errors:
              print('VALIDATION FAILED:')
              for e in errors: print('  - ' + e)
              sys.exit(1)
          print('All assertions passed')
          PYEOF

  idle-check:
    runs-on: ubuntu-latest
    needs: [search-window-cross]
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Wait for polls (120s total)"
        run: sleep 120

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== idle-check: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

  core-then-search:
    runs-on: ubuntu-latest
    needs: [idle-check]
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Scenario: 3 core + 2 search (sequential)"
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 3x core
          for i in $(seq 1 3); do
            echo "--- core call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                "https://api.github.com/repos/${REPO}" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 2
          done

          # 2x search
          for i in $(seq 1 2); do
            echo "--- search call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                "https://api.github.com/search/repositories?q=test" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 2
          done

      - name: "Wait for polls (120s total)"
        run: sleep 100

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== core-then-search: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

      - name: Validate expectations
        if: inputs.strict_validation == 'true'
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor
        run: |
          python3 << 'PYEOF'
          import json, sys, os
          state_path = os.path.join(os.environ['STATE_DIR'], 'state.json')
          with open(state_path) as f:
              state = json.load(f)
          buckets = state.get('buckets', {})
          expectations = {
              'core': {'delta': 3, 'max_windows': 0},
              'search': {'delta': 2, 'max_windows': 0}
          }
          errors = []
          for bucket_name, expect in expectations.items():
              b = buckets.get(bucket_name)
              if not b:
                  errors.append(bucket_name + ': not found in state')
                  continue
              if b['total_used'] < expect['delta']:
                  errors.append(bucket_name + ': total_used=' + str(b['total_used']) + ' < expected ' + str(expect['delta']))
              if b['windows_crossed'] > expect['max_windows']:
                  errors.append(bucket_name + ': windows_crossed=' + str(b['windows_crossed']) + ' > max ' + str(expect['max_windows']))
          if errors:
              print('VALIDATION FAILED:')
              for e in errors: print('  - ' + e)
              sys.exit(1)
          print('All assertions passed')
          PYEOF

  graphql-5:
    runs-on: ubuntu-latest
    needs: [core-then-search]
    steps:
      - uses: actions/checkout@v4

      - name: Start monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Scenario: 5 GraphQL calls"
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 5x graphql
          for i in $(seq 1 5); do
            echo "--- graphql call $i ---"
            curl -s -o /dev/null -w "HTTP %{http_code}\n" \
                -D - \
                -H "Authorization: Bearer $TOKEN" \
                -H "Content-Type: application/json" \
                -d '{"query":"{ viewer { login } }"}' \
                "https://api.github.com/graphql" \
              2>&1 | grep -iE '(^HTTP|x-ratelimit)'
            sleep 2
          done

      - name: "Wait for polls (90s total)"
        run: sleep 70

      - name: Dump state.json
        run: |
          STATE_FILE="${RUNNER_TEMP}/github-api-usage-monitor/state.json"
          echo "=== graphql-5: state.json ==="
          if [ -f "$STATE_FILE" ]; then
            cat "$STATE_FILE" | python3 -m json.tool
          else
            echo "state.json not found"
          fi

      - name: Validate expectations
        if: inputs.strict_validation == 'true'
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor
        run: |
          python3 << 'PYEOF'
          import json, sys, os
          state_path = os.path.join(os.environ['STATE_DIR'], 'state.json')
          with open(state_path) as f:
              state = json.load(f)
          buckets = state.get('buckets', {})
          expectations = {
              'graphql': {'delta': 5, 'max_windows': 0}
          }
          errors = []
          for bucket_name, expect in expectations.items():
              b = buckets.get(bucket_name)
              if not b:
                  errors.append(bucket_name + ': not found in state')
                  continue
              if b['total_used'] < expect['delta']:
                  errors.append(bucket_name + ': total_used=' + str(b['total_used']) + ' < expected ' + str(expect['delta']))
              if b['windows_crossed'] > expect['max_windows']:
                  errors.append(bucket_name + ': windows_crossed=' + str(b['windows_crossed']) + ' > max ' + str(expect['max_windows']))
          if errors:
              print('VALIDATION FAILED:')
              for e in errors: print('  - ' + e)
              sys.exit(1)
          print('All assertions passed')
          PYEOF
