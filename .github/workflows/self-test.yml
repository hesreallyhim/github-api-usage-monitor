name: Self-Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-check:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [20, 22, 24]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install and build
        run: |
          npm ci
          npm run build:all

      - name: Verify dist is up to date
        run: git diff --exit-code -- dist

  test-ubuntu:
    runs-on: ubuntu-latest
    needs: build-check
    steps:
      - uses: actions/checkout@v4

      - name: Start API usage monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Simulate API usage
        run: |
          # Make some API calls to generate usage
          for i in {1..5}; do
            curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }} > /dev/null
            sleep 2
          done

      - name: Stop API usage monitor
        if: always()
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  test-macos:
    runs-on: macos-latest
    needs: build-check
    steps:
      - uses: actions/checkout@v4

      - name: Start API usage monitor
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Simulate API usage
        run: |
          # Make some API calls to generate usage
          for i in {1..5}; do
            curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }} > /dev/null
            sleep 2
          done

      - name: Stop API usage monitor
        if: always()
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  test-windows-unsupported:
    runs-on: windows-latest
    needs: build-check
    steps:
      - uses: actions/checkout@v4

      - name: Start API usage monitor (should fail)
        id: start
        continue-on-error: true
        uses: ./
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Windows is unsupported
        run: |
          if ("${{ steps.start.outcome }}" -ne "failure") {
            Write-Error "Expected Windows to fail but it succeeded"
            exit 1
          }
          Write-Output "Windows correctly reported as unsupported"
