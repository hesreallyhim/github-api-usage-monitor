# AUTO-GENERATED by scripts/generate-self-test.ts — do not edit manually
# Regenerate: npx tsx scripts/generate-self-test.ts

name: Self-Test

on:
  workflow_dispatch:
    inputs:
      strict_validation:
        description: "Fail jobs on assertion mismatch"
        type: boolean
        default: true
      run_baseline:
        description: "Run scenario: Baseline — zero calls"
        type: boolean
        default: true
      run_core_5:
        description: "Run scenario: 5 core GET calls"
        type: boolean
        default: true
      run_core_10:
        description: "Run scenario: 10 core GET calls"
        type: boolean
        default: true
      run_search_2:
        description: "Run scenario: 2 search calls"
        type: boolean
        default: true
      run_code_search_2:
        description: "Run scenario: 2 code_search calls"
        type: boolean
        default: true
      run_graphql_2:
        description: "Run scenario: 2 GraphQL calls"
        type: boolean
        default: true
      run_mixed_small:
        description: "Run scenario: Mixed — 2 core + 2 search + 2 graphql"
        type: boolean
        default: true
      run_core_burst:
        description: "Run scenario: 5 core GET calls — burst (no sleep)"
        type: boolean
        default: true
      run_search_window_cross:
        description: "Run scenario: 2 search calls — 65s apart (window crossing)"
        type: boolean
        default: true
      run_idle_check:
        description: "Run scenario: Idle check — no calls, 120s observation"
        type: boolean
        default: true
      run_core_then_search:
        description: "Run scenario: 3 core + 2 search (sequential)"
        type: boolean
        default: true
      run_graphql_5:
        description: "Run scenario: 5 GraphQL calls"
        type: boolean
        default: true

concurrency:
  group: self-test
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  scenario:
    name: Scenario — ${{ matrix.name }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        include:
          - id: baseline
            name: "Baseline — zero calls"
            has_expected: false
          - id: core-5
            name: "5 core GET calls"
            has_expected: true
          - id: core-10
            name: "10 core GET calls"
            has_expected: true
          - id: search-2
            name: "2 search calls"
            has_expected: true
          - id: code-search-2
            name: "2 code_search calls"
            has_expected: true
          - id: graphql-2
            name: "2 GraphQL calls"
            has_expected: true
          - id: mixed-small
            name: "Mixed — 2 core + 2 search + 2 graphql"
            has_expected: true
          - id: core-burst
            name: "5 core GET calls — burst (no sleep)"
            has_expected: true
          - id: search-window-cross
            name: "2 search calls — 65s apart (window crossing)"
            has_expected: true
          - id: idle-check
            name: "Idle check — no calls, 120s observation"
            has_expected: false
          - id: core-then-search
            name: "3 core + 2 search (sequential)"
            has_expected: true
          - id: graphql-5
            name: "5 GraphQL calls"
            has_expected: true
    steps:
      - uses: actions/checkout@v4

      - name: Check scenario enabled
        id: gate
        env:
          SCENARIO_ID: ${{ matrix.id }}
        run: node scripts/check-scenario-enabled.mjs

      - name: Start monitor
        id: monitor
        if: ${{ steps.gate.outputs.enabled == 'true' }}
        uses: hesreallyhim/github-api-usage-monitor@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          diagnostics: true
          artifact_name: github-api-usage-monitor-${{ matrix.id }}

      - name: Run scenario
        if: ${{ steps.gate.outputs.enabled == 'true' }}
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SCENARIO_ID: ${{ matrix.id }}
        run: node scripts/run-scenario.mjs

  scenario-diag:
    name: Diagnostics — ${{ matrix.name }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    needs: [scenario]
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        include:
          - id: baseline
            name: "Baseline — zero calls"
            has_expected: false
          - id: core-5
            name: "5 core GET calls"
            has_expected: true
          - id: core-10
            name: "10 core GET calls"
            has_expected: true
          - id: search-2
            name: "2 search calls"
            has_expected: true
          - id: code-search-2
            name: "2 code_search calls"
            has_expected: true
          - id: graphql-2
            name: "2 GraphQL calls"
            has_expected: true
          - id: mixed-small
            name: "Mixed — 2 core + 2 search + 2 graphql"
            has_expected: true
          - id: core-burst
            name: "5 core GET calls — burst (no sleep)"
            has_expected: true
          - id: search-window-cross
            name: "2 search calls — 65s apart (window crossing)"
            has_expected: true
          - id: idle-check
            name: "Idle check — no calls, 120s observation"
            has_expected: false
          - id: core-then-search
            name: "3 core + 2 search (sequential)"
            has_expected: true
          - id: graphql-5
            name: "5 GraphQL calls"
            has_expected: true
    steps:
      - uses: actions/checkout@v4

      - name: Check scenario enabled
        id: gate
        env:
          SCENARIO_ID: ${{ matrix.id }}
        run: node scripts/check-scenario-enabled.mjs

      - name: Download diagnostics artifacts
        if: ${{ steps.gate.outputs.enabled == 'true' && needs.scenario.result != 'skipped' }}
        uses: actions/download-artifact@v6
        with:
          name: github-api-usage-monitor-${{ matrix.id }}
          path: ${{ runner.temp }}/github-api-usage-monitor-artifacts/${{ matrix.id }}

      - name: Validate expectations
        if: ${{ steps.gate.outputs.enabled == 'true' && matrix.has_expected && needs.scenario.result == 'success' }}
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor-artifacts/${{ matrix.id }}
          STRICT_VALIDATION: ${{ inputs.strict_validation }}
          SCENARIO_ID: ${{ matrix.id }}
        run: node scripts/validate-scenario.mjs

      - name: Render diagnostics
        if: ${{ steps.gate.outputs.enabled == 'true' && needs.scenario.result != 'skipped' }}
        env:
          STATE_DIR: ${{ runner.temp }}/github-api-usage-monitor-artifacts/${{ matrix.id }}
          SCENARIO_NAME: ${{ matrix.name }}
        run: node scripts/render-diagnostics.mjs >> "$GITHUB_STEP_SUMMARY"
